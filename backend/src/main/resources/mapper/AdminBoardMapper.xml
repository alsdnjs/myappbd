<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="myapp.backend.domain.admin.adminboard.mapper.AdminBoardMapper">

    <!-- 관리자용 게시글 목록 조회 (신고 정보 포함) -->
    <select id="getAdminBoardList" resultType="myapp.backend.domain.admin.adminboard.vo.AdminBoardVO">
        SELECT 
            b.board_id,
            b.board_content,
            b.uploaded_at,
            b.view,
            b.user_id,
            b.image_id,
            u.username,
            i.image_url,
            COALESCE(r.report_count, 0) as reportCount,
            CASE WHEN r.report_count > 0 THEN true ELSE false END as isReported
        FROM board b
        LEFT JOIN user u ON b.user_id = u.user_id
        LEFT JOIN images i ON b.image_id = i.image_id
        LEFT JOIN (
            SELECT board_id, COUNT(*) as report_count
            FROM reports
            GROUP BY board_id
        ) r ON b.board_id = r.board_id
        ORDER BY b.uploaded_at DESC
    </select>

    <!-- 관리자용 게시글 상세 조회 (신고 정보 포함) -->
    <select id="getAdminBoardDetail" parameterType="int" resultType="myapp.backend.domain.admin.adminboard.vo.AdminBoardVO">
        SELECT 
            b.board_id,
            b.board_content,
            b.uploaded_at,
            b.view,
            b.user_id,
            b.image_id,
            u.username,
            i.image_url,
            COALESCE(r.report_count, 0) as reportCount,
            CASE WHEN r.report_count > 0 THEN true ELSE false END as isReported
        FROM board b
        LEFT JOIN user u ON b.user_id = u.user_id
        LEFT JOIN images i ON b.image_id = i.image_id
        LEFT JOIN (
            SELECT board_id, COUNT(*) as report_count
            FROM reports
            GROUP BY board_id
        ) r ON b.board_id = r.board_id
        WHERE b.board_id = #{board_id}
    </select>

    <!-- 관리자용 게시글 삭제 -->
    <delete id="deleteAdminBoard" parameterType="int">
        DELETE FROM board WHERE board_id = #{board_id}
    </delete>

    <!-- 게시글 신고 수 조회 -->
    <select id="getBoardReportCount" parameterType="int" resultType="Integer">
        SELECT COUNT(*) FROM reports WHERE board_id = #{board_id}
    </select>

    <!-- 게시글 신고 상태 확인 -->
    <select id="isBoardReported" parameterType="int" resultType="Boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN true ELSE false END 
        FROM reports WHERE board_id = #{board_id}
    </select>

</mapper>
